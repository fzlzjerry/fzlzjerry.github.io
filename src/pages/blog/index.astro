---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');
const categories = [...new Set(allPosts.map(post => post.data.category).filter(Boolean))];
const tags = [...new Set(allPosts.flatMap(post => post.data.tags))];

const sortedPosts = allPosts.sort((a, b) => 
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);
---

<Layout
  title="Blog - Morax Cheng"
  description="Browse Morax Cheng's blog for articles on programming, technology, economics, and personal reflections."
>
  <div class="max-w-3xl mx-auto">
    <!-- Page Header -->
    <header class="py-12 md:py-20 reveal">
      <h1 class="text-3xl md:text-4xl font-serif font-medium text-brand-text mb-4 text-balance">Blog</h1>
      <p class="text-brand-muted text-lg leading-relaxed text-pretty">
        Thoughts, tutorials, and notes on technology and economics.
      </p>
    </header>

    <!-- Filter Section -->
    <div class="pb-10 mb-10 border-b border-white/[0.04] reveal">
      <div class="flex flex-col gap-5">
        <!-- Categories -->
        <div class="flex flex-wrap items-center gap-2">
          <span class="text-xs font-medium text-brand-muted uppercase tracking-wider font-mono mr-1">Categories</span>
          {categories.map(category => (
            <a
              href={`/blog/category/${category?.toLowerCase()}`}
              class="px-3 py-1.5 text-xs font-medium rounded-lg bg-white/[0.04] text-brand-muted border border-white/[0.06] hover:text-brand-accent hover:border-brand-accent/20 hover:bg-brand-accent/[0.06] transition-all duration-fast"
            >
              {category}
            </a>
          ))}
        </div>
        
        <!-- Tags -->
        <div class="flex flex-wrap items-center gap-2">
          <span class="text-xs font-medium text-brand-muted uppercase tracking-wider font-mono mr-1">Tags</span>
          {tags.slice(0, 8).map(tag => (
            <a
              href={`/blog/tag/${tag?.toLowerCase()}`}
              class="px-2 py-1 text-xs text-neutral-600 hover:text-brand-accent transition-colors duration-fast font-mono"
            >
              #{tag}
            </a>
          ))}
        </div>
      </div>
    </div>

    <!-- Posts List -->
    <section class="flex flex-col">
      {sortedPosts.map((post, index) => (
        <article class={`group relative reveal stagger-${Math.min(index + 1, 5)}`}>
          <a href={`/blog/${post.slug}`} class="block py-6 -mx-4 px-4 rounded-xl transition-all duration-smooth hover:bg-white/[0.02]">
            <div class="flex flex-col gap-3">
              <!-- Meta -->
              <div class="flex items-center gap-3 text-xs text-neutral-600 font-mono">
                <time datetime={post.data.date}>
                  {new Date(post.data.date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                  })}
                </time>
                {post.data.category && (
                  <>
                    <span class="text-neutral-700" aria-hidden="true">/</span>
                    <span class="text-brand-muted">{post.data.category}</span>
                  </>
                )}
              </div>

              <!-- Title -->
              <h2 class="text-lg font-medium text-brand-text group-hover:text-brand-accent transition-colors duration-smooth font-serif">
                {post.data.title}
              </h2>
              
              <!-- Excerpt -->
              {post.data.excerpt && (
                <p class="text-brand-muted text-sm leading-relaxed line-clamp-2">
                  {post.data.excerpt}
                </p>
              )}

              <!-- Tags -->
              {post.data.tags && (
                <div class="flex flex-wrap gap-2 pt-1">
                  {post.data.tags.map(tag => (
                    <span class="inline-flex items-center px-2 py-0.5 text-xs text-neutral-600 font-mono">
                      #{tag}
                    </span>
                  ))}
                </div>
              )}
            </div>
          </a>
          
          <!-- Separator line -->
          <div class="h-px bg-white/[0.04]" aria-hidden="true"></div>
        </article>
      ))}
    </section>
  </div>
</Layout>
