---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const formattedDate = new Date(post.data.date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<Layout title={`${post.data.title} - Morax Cheng`} description={post.data.excerpt}>
  <!-- Reading Progress Bar -->
  <div id="progress-container" class="fixed top-0 left-0 w-full h-1 z-[100] bg-transparent">
    <div id="progress-bar" class="h-full w-0 transition-all duration-100 ease-out origin-left rounded-r-full" style="background: linear-gradient(90deg, #C4893A, #E8A838); box-shadow: 0 0 10px rgba(232,168,56,0.5);"></div>
  </div>

  <article class="max-w-3xl mx-auto animate-on-scroll">
    <header class="mb-12 text-center">
      <div class="flex items-center justify-center gap-2 text-sm text-[#6B6B65] font-grotesk mb-6">
        <time datetime={post.data.date}>{formattedDate}</time>
        {post.data.category && (
          <>
            <span class="text-[#4A4A45]">&middot;</span>
            <span class="font-medium text-[#A8A8A0]">{post.data.category}</span>
          </>
        )}
      </div>

      <h1 class="text-3xl md:text-4xl lg:text-5xl font-display text-[#F5F5F0] mb-6 leading-tight">
        {post.data.title}
      </h1>

      {(post.data.institution || post.data.professor || post.data.authors) && (
        <div class="flex flex-wrap justify-center gap-4 text-sm text-[#6B6B65] py-4 mt-8">
          <div class="gradient-divider w-full"></div>
          <div class="flex flex-wrap justify-center gap-4 py-2">
            {post.data.authors && (
              <div class="flex gap-1">
                <span class="text-[#4A4A45]">By</span>
                <span class="font-medium text-[#A8A8A0]">{post.data.authors.join(', ')}</span>
              </div>
            )}
            {post.data.institution && (
              <div class="hidden sm:block text-[#4A4A45]">|</div>
            )}
            {post.data.institution && (
              <div class="text-[#A8A8A0]">{post.data.institution}</div>
            )}
          </div>
          <div class="gradient-divider w-full"></div>
        </div>
      )}
    </header>

    <div class="prose prose-lg max-w-none prose-headings:font-display prose-headings:font-normal prose-a:text-[#E8A838] prose-a:no-underline prose-a:border-b prose-a:border-[rgba(232,168,56,0.3)] hover:prose-a:border-[#E8A838] prose-img:rounded-[4px] prose-pre:bg-[#141416] prose-pre:border prose-pre:border-white/[0.06]">
      <Content />
    </div>

    <!-- Tags Footer -->
    {post.data.tags && (
      <div class="mt-16 pt-8">
        <div class="gradient-divider mb-8"></div>
        <div class="flex flex-wrap gap-2">
          {post.data.tags.map(tag => (
            <a
              href={`/blog/tag/${tag.toLowerCase()}`}
              class="px-3 py-1 bg-white/[0.03] text-[#A8A8A0] text-sm rounded-[2px] border border-white/[0.06] hover:bg-white/[0.06] hover:text-[#E8A838] hover:border-[rgba(232,168,56,0.3)] transition-all"
            >
              #{tag}
            </a>
          ))}
        </div>
      </div>
    )}
  </article>

  <script>
    function updateProgress() {
      const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
      const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      const progressBar = document.getElementById("progress-bar");
      if (progressBar) {
        progressBar.style.width = scrolled + "%";
      }
    }

    document.addEventListener('scroll', updateProgress);

    document.addEventListener('astro:page-load', () => {
      document.removeEventListener('scroll', updateProgress);
      document.addEventListener('scroll', updateProgress);
    });
  </script>
</Layout>
