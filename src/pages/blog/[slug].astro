---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const formattedDate = new Date(post.data.date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<Layout title={`${post.data.title} - Morax Cheng`} description={post.data.excerpt}>
  <!-- Reading Progress Bar -->
  <div id="progress-container" class="fixed top-0 left-0 w-full h-[2px] z-[100] bg-transparent">
    <div id="progress-bar" class="h-full bg-gradient-to-r from-brand-accent to-brand-accent/60 w-0 transition-all duration-100 ease-out origin-left"></div>
  </div>

  <article class="max-w-3xl mx-auto">
    <!-- Article Header -->
    <header class="py-12 md:py-20 reveal">
      <!-- Back link -->
      <a href="/blog" class="group inline-flex items-center gap-2 text-sm text-brand-muted hover:text-brand-accent transition-colors duration-fast mb-8">
        <i class="fa-solid fa-arrow-left text-xs transition-transform duration-fast group-hover:-translate-x-0.5" aria-hidden="true"></i>
        Back to Blog
      </a>
      
      <!-- Meta -->
      <div class="flex items-center gap-3 text-sm text-brand-muted mb-6 font-mono">
        <time datetime={post.data.date}>{formattedDate}</time>
        {post.data.category && (
          <>
            <span class="text-neutral-700" aria-hidden="true">/</span>
            <a href={`/blog/category/${post.data.category.toLowerCase()}`} class="text-brand-accent hover:underline">
              {post.data.category}
            </a>
          </>
        )}
      </div>
      
      <!-- Title -->
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-serif font-medium text-brand-text leading-tight mb-6">
        {post.data.title}
      </h1>

      <!-- Authors / Institution -->
      {(post.data.institution || post.data.professor || post.data.authors) && (
        <div class="flex flex-wrap gap-4 text-sm text-brand-muted border-t border-white/[0.04] pt-6 mt-2">
          {post.data.authors && (
            <div class="flex gap-1.5">
              <span class="text-neutral-600">By</span>
              <span class="font-medium text-brand-text">{post.data.authors.join(', ')}</span>
            </div>
          )}
          {post.data.institution && (
            <>
              <span class="hidden sm:block text-neutral-700" aria-hidden="true">|</span>
              <div>{post.data.institution}</div>
            </>
          )}
        </div>
      )}
    </header>

    <!-- Divider -->
    <div class="h-px bg-gradient-to-r from-brand-accent/20 via-white/[0.06] to-transparent mb-12" aria-hidden="true"></div>

    <!-- Article Content -->
    <div class="prose prose-lg max-w-none prose-headings:font-serif prose-headings:font-medium reveal">
      <Content />
    </div>
    
    <!-- Tags Footer -->
    {post.data.tags && (
      <div class="mt-16 pt-8 border-t border-white/[0.04] reveal">
        <div class="flex flex-wrap gap-2">
          {post.data.tags.map(tag => (
            <a 
              href={`/blog/tag/${tag.toLowerCase()}`}
              class="px-3 py-1.5 bg-white/[0.04] text-brand-muted text-sm rounded-lg hover:text-brand-accent hover:bg-brand-accent/[0.06] border border-white/[0.06] hover:border-brand-accent/20 transition-all duration-fast font-mono"
            >
              #{tag}
            </a>
          ))}
        </div>
      </div>
    )}
  </article>

  <script>
    function updateProgress() {
      const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
      const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      const progressBar = document.getElementById("progress-bar");
      if (progressBar) {
        progressBar.style.width = scrolled + "%";
      }
    }

    const setupProgress = () => {
      document.removeEventListener('scroll', updateProgress);
      document.addEventListener('scroll', updateProgress);
    };

    setupProgress();
    document.addEventListener('astro:page-load', setupProgress);
  </script>
</Layout>
