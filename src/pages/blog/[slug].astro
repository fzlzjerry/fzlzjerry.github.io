---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const formattedDate = new Date(post.data.date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<Layout title={`${post.data.title} - Morax Cheng`} description={post.data.excerpt}>
  <!-- Reading Progress Bar -->
  <div id="progress-container" class="fixed top-0 left-0 w-full h-1 z-[100] bg-transparent">
    <div id="progress-bar" class="h-full bg-zinc-900 w-0 transition-all duration-100 ease-out origin-left"></div>
  </div>

  <article class="max-w-3xl mx-auto animate-on-scroll">
    <header class="mb-12 text-center">
      <div class="flex items-center justify-center gap-2 text-sm text-zinc-500 mb-6">
        <time datetime={post.data.date}>{formattedDate}</time>
        {post.data.category && (
          <>
            <span>Â·</span>
            <span class="font-medium text-zinc-700">{post.data.category}</span>
          </>
        )}
      </div>
      
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-serif font-medium text-zinc-900 mb-6 leading-tight">
        {post.data.title}
      </h1>

      {(post.data.institution || post.data.professor || post.data.authors) && (
        <div class="flex flex-wrap justify-center gap-4 text-sm text-zinc-500 border-t border-b border-zinc-100 py-4 mt-8">
          {post.data.authors && (
            <div class="flex gap-1">
              <span class="text-zinc-400">By</span>
              <span class="font-medium text-zinc-700">{post.data.authors.join(', ')}</span>
            </div>
          )}
          {post.data.institution && (
            <div class="hidden sm:block text-zinc-300">|</div>
          )}
          {post.data.institution && (
            <div>{post.data.institution}</div>
          )}
        </div>
      )}
    </header>

    <div class="prose prose-zinc prose-lg max-w-none prose-headings:font-serif prose-headings:font-medium prose-a:text-zinc-900 prose-a:no-underline prose-a:border-b prose-a:border-zinc-300 hover:prose-a:border-zinc-900 prose-img:rounded-xl prose-pre:bg-zinc-50 prose-pre:border prose-pre:border-zinc-100">
      <Content />
    </div>
    
    <!-- Tags Footer -->
    {post.data.tags && (
      <div class="mt-16 pt-8 border-t border-zinc-100">
        <div class="flex flex-wrap gap-2">
          {post.data.tags.map(tag => (
            <a 
              href={`/blog/tag/${tag.toLowerCase()}`}
              class="px-3 py-1 bg-zinc-50 text-zinc-600 text-sm rounded-full hover:bg-zinc-100 transition-colors"
            >
              #{tag}
            </a>
          ))}
        </div>
      </div>
    )}
  </article>

  <script>
    function updateProgress() {
      const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
      const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      const progressBar = document.getElementById("progress-bar");
      if (progressBar) {
        progressBar.style.width = scrolled + "%";
      }
    }

    document.addEventListener('scroll', updateProgress);
    // View Transitions cleanup is handled automatically for inline scripts in Astro components? 
    // Actually no, if this script re-runs, it adds another listener.
    // We should probably clean up or use a named function with check.
    
    // Better:
    document.addEventListener('astro:page-load', () => {
      document.removeEventListener('scroll', updateProgress);
      document.addEventListener('scroll', updateProgress);
    });
  </script>
</Layout>
