---
interface Props {
  id: string;
}

const { id } = Astro.props;
---

<div
  id={id}
  class="modal fixed inset-0 z-50 hidden items-center justify-center p-4"
  style="background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);"
  onclick="if (event.target === this) { this.classList.add('hidden'); this.classList.remove('flex'); }"
  role="dialog"
  aria-modal="true"
  aria-labelledby={`${id}-title`}
>
  <div class="max-w-4xl w-full rounded-xl overflow-hidden modal-content border border-white/[0.06]" style="background-color: #161618;">
    <div class="relative">
      <button
        onclick="this.closest('.modal').classList.add('hidden'); this.closest('.modal').classList.remove('flex');"
        class="close-btn absolute top-4 right-4 rounded-full p-2 transition-all z-10 bg-brand-bg/60 backdrop-blur border border-white/[0.08] text-brand-muted hover:text-brand-text hover:bg-brand-bg/90"
        aria-label="Close modal"
        tabindex="0"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
      <img
        src=""
        alt="Certificate"
        class="w-full h-auto loaded"
        id={`${id}-image`}
        style="display: block;"
      />
    </div>
  </div>
</div>

<style>
  .modal {
    animation: fadeIn 200ms ease-out;
  }
  
  .modal-content {
    animation: scaleIn 200ms ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes scaleIn {
    from {
      transform: scale(0.95);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }
  
  .close-btn:hover {
    transform: scale(1.1);
  }
  
  .close-btn:focus-visible {
    outline: 2px solid #5eead4;
    outline-offset: 2px;
  }
</style>

<script define:vars={{ id }}>
document.querySelectorAll(`[data-modal="${id}"]`).forEach(trigger => {
  trigger.addEventListener('click', (e) => {
    e.preventDefault();
    const modal = document.getElementById(id);
    const modalImg = document.getElementById(`${id}-image`);
    modalImg.src = trigger.getAttribute('href');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    const focusableElements = modal.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])');
    const firstElement = focusableElements[0];
    const lastElement = focusableElements[focusableElements.length - 1];
    
    setTimeout(() => firstElement?.focus(), 100);
    
    const trapFocus = (e) => {
      if (e.key === 'Tab') {
        if (e.shiftKey) {
          if (document.activeElement === firstElement) {
            e.preventDefault();
            lastElement?.focus();
          }
        } else {
          if (document.activeElement === lastElement) {
            e.preventDefault();
            firstElement?.focus();
          }
        }
      }
    };
    
    modal.addEventListener('keydown', trapFocus);
    modal._trapFocus = trapFocus;
  });
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const modal = document.getElementById(id);
    if (modal && !modal.classList.contains('hidden')) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      if (modal._trapFocus) {
        modal.removeEventListener('keydown', modal._trapFocus);
      }
    }
  }
});
</script>
