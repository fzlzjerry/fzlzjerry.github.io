---
import { getCollection } from 'astro:content';

// Fetch content for indexing
const posts = await getCollection('blog');
const searchItems = [
  // Pages
  { title: 'Home', href: '/', type: 'Page', icon: 'fa-home' },
  { title: 'Projects', href: '/projects', type: 'Page', icon: 'fa-code' },
  { title: 'Gallery', href: '/gallery', type: 'Page', icon: 'fa-images' },
  { title: 'Blog', href: '/blog', type: 'Page', icon: 'fa-pen-nib' },
  { title: 'Awards', href: '/awards', type: 'Page', icon: 'fa-trophy' },
  { title: 'About', href: '/about', type: 'Page', icon: 'fa-user' },
  // Blog Posts
  ...posts.map(post => ({
    title: post.data.title,
    href: `/blog/${post.slug}`,
    type: 'Blog',
    description: post.data.excerpt,
    icon: 'fa-article'
  }))
];
---

<div id="command-palette-container" class="hidden relative z-[100]" role="dialog" aria-modal="true">
  <!-- Backdrop -->
  <div id="palette-backdrop" class="fixed inset-0 bg-black/72 transition-opacity opacity-0"></div>

  <!-- Modal Positioner -->
  <div class="fixed inset-0 z-[100] overflow-y-auto p-4 sm:p-6 md:p-20">
    <!-- Modal Panel -->
    <div
      id="palette-panel"
      class="mx-auto max-w-xl transform divide-y divide-white/[0.08] overflow-hidden rounded-[4px] bg-[#111114] shadow-[8px_8px_0_rgba(0,0,0,0.34)] border border-white/[0.12] transition-all scale-95 opacity-0"
    >
      <div class="relative">
        <i class="fa-solid fa-magnifying-glass absolute top-3.5 left-4 h-5 w-5 text-[#6B6B65]"></i>
        <input
          type="text"
          id="palette-input"
          class="h-12 w-full border-0 bg-transparent pl-11 pr-4 text-[#F5F5F0] placeholder:text-[#4A4A45] focus:ring-0 sm:text-sm caret-[#E8A838]"
          placeholder="Search posts, pages, and more..."
          role="combobox"
          aria-expanded="false"
          aria-controls="palette-results"
        />
        <div class="absolute top-3.5 right-4 flex items-center gap-1">
           <kbd class="hidden sm:inline-block px-1.5 py-0.5 text-xs text-[#4A4A45] bg-white/[0.05] border border-white/[0.10] rounded font-mono">ESC</kbd>
        </div>
      </div>

      <ul
        id="palette-results"
        class="max-h-80 scroll-py-2 overflow-y-auto p-2"
        role="listbox"
      >
        <!-- Results injected here -->
      </ul>

      <div id="palette-empty" class="hidden py-14 px-6 text-center text-sm sm:px-14">
        <i class="fa-regular fa-face-sad-tear text-2xl text-[#4A4A45] mx-auto mb-4"></i>
        <p class="mt-4 font-semibold text-[#F5F5F0]">No results found</p>
        <p class="mt-2 text-[#6B6B65]">We couldn't find anything with that term. Please try again.</p>
      </div>

      <div class="py-2.5 px-4 bg-white/[0.02] border-t border-white/[0.06] text-xs text-[#4A4A45] flex items-center justify-between">
        <div class="flex gap-3">
          <span class="flex items-center gap-1"><kbd class="font-mono bg-white/[0.05] border border-white/[0.10] rounded px-1 text-[#6B6B65]">&uarr;</kbd> <kbd class="font-mono bg-white/[0.05] border border-white/[0.10] rounded px-1 text-[#6B6B65]">&darr;</kbd> to navigate</span>
          <span class="flex items-center gap-1"><kbd class="font-mono bg-white/[0.05] border border-white/[0.10] rounded px-1 text-[#6B6B65]">&crarr;</kbd> to select</span>
        </div>
        <span class="flex items-center gap-1">Search by <span class="font-semibold text-[#E8A838]">Morax</span></span>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ searchItems }}>
  // Core Logic
  let isOpen = false;
  let query = '';
  let selectedIndex = 0;
  let filteredItems = searchItems || [];

  // Helpers
  function getElements() {
    return {
      container: document.getElementById('command-palette-container'),
      backdrop: document.getElementById('palette-backdrop'),
      panel: document.getElementById('palette-panel'),
      input: document.getElementById('palette-input'),
      resultsList: document.getElementById('palette-results'),
      emptyState: document.getElementById('palette-empty')
    };
  }

  function isPaletteOpen() {
    const { container } = getElements();
    return container && !container.classList.contains('hidden');
  }

  function openPalette() {
    const { container, backdrop, panel, input } = getElements();
    if (!container || isPaletteOpen()) return;

    container.classList.remove('hidden');

    requestAnimationFrame(() => {
      backdrop.classList.remove('opacity-0');
      panel.classList.remove('scale-95', 'opacity-0');
    });

    if (input) {
      input.value = '';
      input.focus();
    }
    query = '';
    filterItems('');
    document.body.style.overflow = 'hidden';
  }

  function closePalette() {
    const { container, backdrop, panel } = getElements();
    if (!container || !isPaletteOpen()) return;

    backdrop.classList.add('opacity-0');
    panel.classList.add('scale-95', 'opacity-0');

    setTimeout(() => {
      container.classList.add('hidden');
      document.body.style.overflow = '';
    }, 200);
  }

  function filterItems(q) {
    query = q ? q.toLowerCase() : '';
    if (!query) {
      filteredItems = searchItems.slice(0, 8);
    } else {
      filteredItems = searchItems.filter(item =>
        item.title.toLowerCase().includes(query) ||
        (item.description && item.description.toLowerCase().includes(query))
      ).slice(0, 10);
    }

    selectedIndex = 0;
    renderResults();
  }

  function renderResults() {
    const { resultsList, emptyState } = getElements();
    if (!resultsList) return;

    resultsList.innerHTML = '';

    if (!filteredItems || filteredItems.length === 0) {
      resultsList.classList.add('hidden');
      if (emptyState) emptyState.classList.remove('hidden');
      return;
    }

    resultsList.classList.remove('hidden');
    if (emptyState) emptyState.classList.add('hidden');

    filteredItems.forEach((item, index) => {
      const li = document.createElement('li');
      li.role = 'option';
      li.className = `group flex cursor-default select-none items-center rounded-[3px] px-3 py-2 ${index === selectedIndex ? 'bg-white/[0.05] text-[#F5F5F0] border-l-2 border-[#E8A838]' : 'text-[#A8A8A0] hover:bg-white/[0.03]'}`;
      li.innerHTML = `
        <div class="flex h-8 w-8 flex-none items-center justify-center rounded-[3px] bg-white/[0.03] border border-white/[0.06] ${index === selectedIndex ? 'text-[#E8A838]' : 'text-[#6B6B65]'}">
          <i class="fa-solid ${item.icon || 'fa-file'}"></i>
        </div>
        <div class="ml-3 flex-auto truncate">
          <div class="text-sm font-medium ${index === selectedIndex ? 'text-[#F5F5F0]' : 'text-[#A8A8A0]'}">${item.title}</div>
          ${item.description ? `<div class="text-xs text-[#6B6B65] truncate">${item.description}</div>` : `<div class="text-xs text-[#4A4A45]">${item.type}</div>`}
        </div>
      `;

      li.addEventListener('click', () => {
        window.location.href = item.href;
        closePalette();
      });

      li.addEventListener('mouseenter', () => {
        selectedIndex = index;
        updateSelection();
      });

      resultsList.appendChild(li);
    });
  }

  function updateSelection() {
    const { resultsList } = getElements();
    if (!resultsList) return;

    const items = resultsList.children;
    for (let i = 0; i < items.length; i++) {
        const item = items[i];
        const isSelected = i === selectedIndex;
        if (isSelected) {
            item.className = 'group flex cursor-default select-none items-center rounded-[3px] px-3 py-2 bg-white/[0.05] text-[#F5F5F0] border-l-2 border-[#E8A838]';
            item.children[0].className = 'flex h-8 w-8 flex-none items-center justify-center rounded-[3px] bg-white/[0.03] border border-white/[0.06] text-[#E8A838]';
            item.children[1].children[0].className = 'text-sm font-medium text-[#F5F5F0]';
        } else {
            item.className = 'group flex cursor-default select-none items-center rounded-[3px] px-3 py-2 text-[#A8A8A0] hover:bg-white/[0.03]';
            item.children[0].className = 'flex h-8 w-8 flex-none items-center justify-center rounded-[3px] bg-white/[0.03] border border-white/[0.06] text-[#6B6B65]';
            item.children[1].children[0].className = 'text-sm font-medium text-[#A8A8A0]';
        }
    }
  }

  function handleKeydown(e) {
    if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
      e.preventDefault();
      if (isPaletteOpen()) closePalette();
      else openPalette();
    }

    if (e.key === 'Escape') {
      closePalette();
    }

    if (!isPaletteOpen()) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = (selectedIndex + 1) % filteredItems.length;
      updateSelection();
      scrollSelectedIntoView();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = (selectedIndex - 1 + filteredItems.length) % filteredItems.length;
      updateSelection();
      scrollSelectedIntoView();
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (filteredItems[selectedIndex]) {
        window.location.href = filteredItems[selectedIndex].href;
        closePalette();
      }
    }
  }

  function scrollSelectedIntoView() {
    const { resultsList } = getElements();
    if (!resultsList) return;
    const selectedEl = resultsList.children[selectedIndex];
    if (selectedEl) {
      selectedEl.scrollIntoView({ block: 'nearest' });
    }
  }

  // Robust Setup using global handler tracking
  document.addEventListener('astro:page-load', () => {
    if (!searchItems || searchItems.length === 0) {
      console.error('Command Palette: No search items found.');
    }

    if (window.__cmdPaletteOpen) {
      document.removeEventListener('open-command-palette', window.__cmdPaletteOpen);
    }
    if (window.__cmdPaletteKey) {
      document.removeEventListener('keydown', window.__cmdPaletteKey);
    }

    window.__cmdPaletteOpen = openPalette;
    window.__cmdPaletteKey = handleKeydown;

    document.addEventListener('open-command-palette', window.__cmdPaletteOpen);
    document.addEventListener('keydown', window.__cmdPaletteKey);

    const { input, backdrop } = getElements();
    if (input) input.oninput = (e) => filterItems(e.target.value);
    if (backdrop) backdrop.onclick = closePalette;

    isOpen = false;
  });
</script>
